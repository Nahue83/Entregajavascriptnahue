// ============================
// Simulador de Carrito - Pasteler√≠a
// Entregable 1 ‚Äî CoderHouse (Funciones, par√°metros, arrays, objetos, condicionales, bucles, consola y di√°logos)
// ============================

// ----- Datos base (const, arrays de objetos) -----
const IVA = 0.21;
const CUPON_VALIDO = "PROMO10";  // 10% off

// Cat√°logo de productos (array de objetos)
const productos = [
  { id: 1, nombre: "Selva Negra", precio: 30000 },
  { id: 2, nombre: "Chaj√°", precio: 30000 },
  { id: 3, nombre: "Lemon Pie", precio: 12000 },
  { id: 4, nombre: "Tarta Frutales ", precio: 32000 },
  { id: 5, nombre: "Brownie", precio: 18000 }
];

// Carrito (array de objetos con cantidad)
let carrito = [];

// ----- Utilidades (funciones puras) -----
/**
 * Busca un producto por ID en el cat√°logo.
 * @param {number} id
 * @returns {object|undefined}
 */
function buscarProductoPorId(id) {
  return productos.find(p => p.id === id);
}

/**
 * Calcula el subtotal del carrito (sin IVA).
 * @returns {number}
 */
function calcularSubtotal() {
  return carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
}

/**
 * Aplica cup√≥n si corresponde y devuelve el total con descuento.
 * @param {number} monto
 * @param {string} cupon
 * @returns {number}
 */
function aplicarCupon(monto, cupon) {
  if (typeof cupon === "string" && cupon.toUpperCase().trim() === CUPON_VALIDO) {
    return monto * 0.90; // 10% dto
  }
  return monto;
}

// ----- Funciones principales (interacci√≥n) -----
/**
 * Muestra los productos disponibles en consola.
 */
function listarProductos() {
  console.clear();
  console.log("=== Cat√°logo de Pasteler√≠a ===");
  for (const p of productos) {
    console.log(`#${p.id} - ${p.nombre} ‚Äî $${p.precio}`);
  }
  console.log("\nUs√° la opci√≥n 'Agregar' en el men√∫ para sumarlos al carrito.");
}

/**
 * Agrega un producto al carrito por ID y cantidad (valida entradas).
 * @param {number} id
 * @param {number} cantidad
 */
function agregarAlCarrito(id, cantidad) {
  const producto = buscarProductoPorId(id);
  if (!producto) {
    alert("‚ùå Producto inexistente. Prob√° con un ID del 1 al " + productos.length + ".");
    return;
  }
  if (isNaN(cantidad) || cantidad <= 0) {
    alert("‚ö†Ô∏è Cantidad inv√°lida.");
    return;
  }
  // Si ya existe en el carrito, acumular cantidad
  const existente = carrito.find(item => item.id === id);
  if (existente) {
    existente.cantidad += cantidad;
  } else {
    carrito.push({ id: producto.id, nombre: producto.nombre, precio: producto.precio, cantidad });
  }
  alert(`‚úÖ Agregaste ${cantidad} √ó ${producto.nombre} al carrito.`);
  mostrarCarrito();
}

/**
 * Quita un producto del carrito por ID.
 * @param {number} id
 */
function quitarDelCarrito(id) {
  const index = carrito.findIndex(item => item.id === id);
  if (index === -1) {
    alert("‚ö†Ô∏è Ese producto no est√° en tu carrito.");
    return;
  }
  const quitado = carrito.splice(index, 1)[0];
  alert(`üóëÔ∏è Quitaste ${quitado.nombre} del carrito.`);
  mostrarCarrito();
}

/**
 * Imprime el contenido del carrito en consola.
 */
function mostrarCarrito() {
  console.clear();
  console.log("=== Tu Carrito ===");
  if (carrito.length === 0) {
    console.log("Vac√≠o por ahora. Agreg√° algo rico üòã");
    return;
  }
  for (const item of carrito) {
    console.log(`${item.cantidad} √ó ${item.nombre} ‚Äî $${item.precio} c/u`);
  }
  console.log("------------------------");
  console.log("Subtotal: $", calcularSubtotal());
}

/**
 * Finaliza la compra: aplica IVA y cup√≥n opcional. Muestra resumen con alert.
 */
function finalizarCompra() {
  if (carrito.length === 0) {
    alert("üõí Tu carrito est√° vac√≠o.");
    return;
  }
  const subtotal = calcularSubtotal();
  const subtotalConIva = subtotal * (1 + IVA);

  const quiereCupon = confirm("¬øTen√©s un cup√≥n de descuento?");
  let cuponIngresado = "";
  if (quiereCupon) {
    cuponIngresado = prompt("Ingres√° tu cup√≥n (ej: PROMO10):") || "";
  }
  const totalConDescuento = aplicarCupon(subtotalConIva, cuponIngresado);

  // Armar mensaje final con saltos de l√≠nea
  const mensaje = [
    "üßæ Resumen de compra",
    "------------------------",
    `Items: ${carrito.map(i => `${i.cantidad}√ó ${i.nombre}`).join(", ")}`,
    `Subtotal: $${subtotal}`,
    `IVA (21%): $${(subtotal*IVA).toFixed(2)}`,
    cuponIngresado.trim() ? `Cup√≥n aplicado (${cuponIngresado.toUpperCase().trim()}): ‚úÖ` : "Cup√≥n aplicado: ‚ùå",
    `TOTAL: $${totalConDescuento.toFixed(2)}`
  ].join("\n");

  alert(mensaje);

  const confirmar = confirm("¬øConfirm√°s la compra?");
  if (confirmar) {
    alert("üéâ ¬°Gracias por tu compra! Tu pedido est√° en camino.");
    carrito = []; // vaciar
    console.clear();
    console.log("Carrito vac√≠o. ¬°Volv√© pronto!");
  } else {
    alert("‚è≥ Compra cancelada. Pod√©s seguir editando el carrito.");
  }
}

/**
 * Men√∫ principal (bucle + condicionales). Controla el flujo del simulador.
 */
function iniciarSimulador() {
  alert("Bienvenid@ a la Pasteler√≠a. Vamos a usar di√°logos y la consola. ¬°Abr√≠ la consola!");
  listarProductos();

  let seguir = true;
  while (seguir) {
    const opcion = prompt(
      "Eleg√≠ una opci√≥n:\n" +
      "1) Listar productos\n" +
      "2) Agregar al carrito\n" +
      "3) Quitar del carrito\n" +
      "4) Ver carrito\n" +
      "5) Finalizar compra\n" +
      "0) Salir"
    );

    if (opcion === null) {
      // Usuario cerr√≥ el prompt => salir
      if (confirm("¬øSeguro que quer√©s salir del simulador?")) {
        seguir = false;
      }
      continue;
    }

    switch (opcion.trim()) {
      case "1":
        listarProductos();
        break;
      case "2": {
        const id = Number(prompt("Ingres√° el ID del producto:"));
        const cantidad = Number(prompt("¬øCu√°ntas unidades?"));
        agregarAlCarrito(id, cantidad);
        break;
      }
      case "3": {
        const id = Number(prompt("ID del producto a quitar:"));
        quitarDelCarrito(id);
        break;
      }
      case "4":
        mostrarCarrito();
        break;
      case "5":
        finalizarCompra();
        break;
      case "0":
        if (confirm("¬øSeguro que quer√©s salir?")) {
          seguir = false;
        }
        break;
      default:
        alert("Opci√≥n inv√°lida. Prob√° de nuevo.");
    }
  }

  alert("¬°Gracias por usar el simulador! Recarg√° la p√°gina para reiniciar.");
}

// Ejecutar al cargar el documento
document.addEventListener("DOMContentLoaded", () => {
  console.log("Simulador listo. Abr√≠ la consola para ver el cat√°logo y mensajes.");
  iniciarSimulador();
});

// ----- Exportar funciones al global para prueba manual (opcional) -----
window.listarProductos = listarProductos;
window.agregarAlCarrito = agregarAlCarrito;
window.quitarDelCarrito = quitarDelCarrito;
window.finalizarCompra = finalizarCompra;
window.iniciarSimulador = iniciarSimulador;